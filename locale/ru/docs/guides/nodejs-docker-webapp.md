---
title: Докеризация веб-приложения node.js
layout: docs.hbs
---

# Докеризация веб-приложения node.js

Цель этого примера — показать, как поместить приложение node.js в docker-контейнер.
Это руководство предназначено для разработки, но не для прямого использования в
продакшене. Мы также предполагаем, что Вы успешно установили docker на свой ПК и
имеете базовое представление того, как структурировано приложение node.js.

В перовой части руководства мы создадим простое node.js приложение, затем 
мы создадим для него docker образ, и, наконец, мы создадим экземпляр контейнера
из этого образа.

Docker позволяет Вам упаковать приложение вместе с его окружением и всеми зависимостями в
"коробку", называемую контейнером. Обычно контейнер состоит из приложения, работающего в
упрощенной версии ОС Linux. Образ — это шаблон для контейнера, контейнер — это работающий
экземпляр образа.

## Создание приложения node.js

Для начала создадим новую директорию, в которой будут находиться все файлы приложения. В этой директории
создайте файл `package.json`, в котором описано приложение и его зависимости:

```json
{
  "name": "docker_web_app",
  "version": "1.0.0",
  "description": "node.js on docker",
  "author": "first last <first.last@example.com>",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "express": "^4.16.1"
  }
}
```

После создания файла `package.json`, выполните команду `npm install`. Если вы используете `npm`
версии 5 или выше, это также создаст файл `package-lock.json`, который будет скопирован в Ваш docker-образ.

Далее создайте файл `server.js` который обозначает веб-приложение с использованием 
фреймворка [express.js](https://expressjs.com/):

```javascript
'use strict';

const express = require('express');

// константы
const port = 8080;
const host = '0.0.0.0';

// приложение
const app = express();
app.get('/', (req, res) => {
  res.send('hello world\n');
});

app.listen(port, host);
console.log(`running on http://${host}:${port}`);
```

Далее мы рассмотрим, как вы можете запускать это приложение внутри docker-контейнера,
используя официальный образ docker. Сперва давайте создадим docker-образ с нашим приложением.

## Создание файла Dockerfile

Создайте пустой файл с именем `Dockerfile`:

```markup
touch Dockerfile
```

Откройте этот файл в Вашем любимом текстовом редакторе.

Первое, что нам надо сделать — определить базовый образ,
который мы возьмем за основу. Мы используем образ `node` последней версии
LTS* (версии с долгосрочной поддержкой) — `10`,
доступный на [docker hub](https://hub.docker.com/).

\* Прим. переводчика: на момент написания статьи.

```docker
FROM node:10
```

Затем создадим директорию, в которой будет содержаться код приложения внутри образа.
Это будет рабочая директория для Вашего приложения.

```docker
# создание директории приложения
WORKDIR /usr/src/app
```

Образ, который мы используем, поставляется с уже предустановленным node.js и npm.
Поэтому мы можем просто установить зависимости приложения с помощью команд `npm`. 
Обратите внимание, если Вы используете `npm` 4 или ниже, файл `package-lock.json`
не будет сгенерирован.

```docker
# установка зависимостей
# символ астериск «*» используется для того чтобы по возможности 
# скопировать оба файла: package.json и package-lock.json
COPY package*.json ./

RUN npm install
# Если вы создаете сборку для продакшн
# RUN npm ci --only=production
```

Обратите внимание, что вместо того, чтобы копировать весь рабочий каталог, 
мы копируем только файл `package.json`. Это позволяет воспользоваться 
кэшированием слоев в docker. По [этой](http://bitjudo.com/blog/2014/03/13/building-efficient-dockerfiles-node-dot-js/) 
ссылке есть хорошее объяснение того, как это работает. Более того,
команда `npm ci`, указанная в комментарии, позволяет создавать
более быстрые, надежные, воспроизводимые сборки для продакшена.
Вы можете прочесть больше об этой команде [здесь](https://blog.npmjs.org/post/171556855892/introducing-npm-ci-for-faster-more-reliable).

Чтобы отправить исходный код Вашего приложения внутрь docker-образа, 
используйте директиву `copy`.

```docker
# копируем исходный код
COPY . .
```

Наш сервер запускается на порту `8080`, поэтому мы будем использовать 
инструкцию `expose`, чтобы проинформировать Docker о том, что в контейнере
имеется приложение, прослушивающее этот порт.

```docker
EXPOSE 8080
```

Последняя, тем не менее важная команда `cmd` содержит все необходимые
переменные среды и инструкции для запуска приложения.
Здесь мы просто используем `node server.js` для запуска.

```docker
CMD [ "node", "server.js" ]
```

Ваш `Dockerfile` теперь должен выглядеть примерно так:

```docker
FROM node:10

# создание директории приложения
WORKDIR /usr/src/app

# установка зависимостей
# символ астериск «*» используется для того чтобы по возможности 
# скопировать оба файла: package.json и package-lock.json
COPY package*.json ./

RUN npm install
# Если вы создаете сборку для продакшн
# RUN npm ci --only=production

# копируем исходный код
COPY . .

EXPOSE 8080
CMD [ "node", "server.js" ]
```

## Файл .dockerignore

Создайте файл `.dockerignore` в той же директории, что и `Dockerfile`,
со следующим содержимым:

```
node_modules
npm-debug.log
```

Это предотвратит копирование локально установленных модулей и дебаг-логов 
в docker-образ и возможную перезапись модулей установленных внутри образа.

## Сборка образа

Перейдите в директорию, в которой находится Ваш `Dockerfile` и запустите
следующую команду, чтобы собрать образ docker. Флаг `-t` позволяет поставить 
тэг к Вашему образу, чтобы его позже было проще найти при помощи команды
`docker images`:

```bash
docker build -t <your username>/node-web-app .
```

Созданный образ теперь будет отображаться в списке всех образов:

```bash
$ docker images

# пример вывода
repository                      tag        id              created
node                            10         1934b0b038d1    5 days ago
<your username>/node-web-app    latest     d64d3505b0d2    1 minute ago
```

## Запуск образа

Запуск образа с флагом `-d` позволяет контейнеру работать в фоновом режиме. 
Флаг `-p` перенаправляет публичный порт на приватный порт внутри контейнера.
Запустите образ, который Вы ранее создали:

```bash
docker run -p 49160:8080 -d <your username>/node-web-app
```

Отобразите вывод вашего приложения:

```bash
# отобразить все контейнеры, чтобы получить id нужного нам
$ docker ps

# отобразить логи вывода
$ docker logs <container_id>

# пример вывода
running on http://localhost:8080
```

Если Вам нужно попасть внутрь контейнера, используйте команду `exec`:

```bash
# войти в контейнер в интерактивном режиме
$ docker exec -it <container id> /bin/bash
```

## Проверка

Чтобы проверить Ваше приложение, используйте публичный порт, к которому привязан контейнер:

```bash
$ docker ps

# пример вывода
id            image                                command    ...   ports
ecce33b30ebf  <your username>/node-web-app:latest  npm start  ...   49160->8080
```

В примере выше docker связал порт `8080` внутри контейнера с портом `49160`
на Вашем компьютере.

Вы можете сделать запрос к Вашему приложению с помощью утилиты `curl`
(установите ее, если требуется с помощью команды: `sudo apt-get install curl`):

```bash
$ curl -i localhost:49160

http/1.1 200 ok
x-powered-by: express
content-type: text/html; charset=utf-8
content-length: 12
etag: w/"c-m6twob/y57lesdjquheb1p/qtv0"
date: mon, 13 nov 2017 20:53:59 gmt
connection: keep-alive

hello world
```

Надеемся, что эта инструкция помогла Вам настроить и запустить простое приложение
node.js с помощью docker.

Вы можете найти больше информации о docker и node.js в docker по следующим ссылкам:

* [Официальный docker-образ node.js](https://hub.docker.com/_/node/)
* [Руководство по лучшим практикам node.js docker](https://github.com/nodejs/docker-node/blob/master/docs/bestpractices.md)
* [Официальная документация docker](https://docs.docker.com/)
* [Тэг docker на stack overflow](https://stackoverflow.com/questions/tagged/docker)
* [Канал docker на reddit](https://reddit.com/r/docker)
